#!/bin/bash
#
# Pre-commit hook for secret scanning
# Prevents commits containing secrets, API keys, tokens, or personal paths
#
# To bypass (not recommended):
#   git commit -m "message --force-secrets"
#

# Colors
RED='\033[0;91m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
RESET='\033[0m'
BOLD='\033[1m'

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$REPO_ROOT" ]; then
    echo -e "${RED}Error: Not in a git repository${RESET}"
    exit 1
fi

# Path to the scanner script
SCANNER="$REPO_ROOT/scripts/scan_secrets.py"

# Check if scanner exists
if [ ! -f "$SCANNER" ]; then
    echo -e "${YELLOW}Warning: Secret scanner not found at $SCANNER${RESET}"
    echo -e "${YELLOW}Skipping secret scan...${RESET}"
    exit 0
fi

# Check for force bypass in commit message (last argument or from file)
COMMIT_MSG_FILE="$1"
FORCE_BYPASS=0

if [ -n "$COMMIT_MSG_FILE" ] && [ -f "$COMMIT_MSG_FILE" ]; then
    if grep -q "\-\-force-secrets" "$COMMIT_MSG_FILE"; then
        FORCE_BYPASS=1
    fi
fi

# Also check GIT_COMMIT_MSG environment variable if set
if [ -n "$GIT_COMMIT_MSG" ]; then
    if echo "$GIT_COMMIT_MSG" | grep -q "\-\-force-secrets"; then
        FORCE_BYPASS=1
    fi
fi

if [ $FORCE_BYPASS -eq 1 ]; then
    echo -e "${YELLOW}âš  Secret scan bypassed with --force-secrets${RESET}"
    echo -e "${YELLOW}Proceeding with commit...${RESET}"
    exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    # No files staged, nothing to scan
    exit 0
fi

echo -e "${BOLD}ğŸ” Scanning for secrets...${RESET}"

# Run the scanner on staged files
python3 "$SCANNER" --staged

SCAN_RESULT=$?

if [ $SCAN_RESULT -eq 1 ]; then
    echo ""
    echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${RED}${BOLD}â•‘  COMMIT BLOCKED: Secrets or sensitive data detected        â•‘${RESET}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "Please remove the sensitive data before committing."
    echo ""
    echo -e "To bypass this check (${RED}NOT RECOMMENDED${RESET}):"
    echo -e "  git commit -m \"your message --force-secrets\""
    echo ""
    exit 1
elif [ $SCAN_RESULT -eq 2 ]; then
    echo -e "${YELLOW}Warning: Error during secret scan, proceeding with caution${RESET}"
    exit 0
fi

echo -e "${GREEN}âœ“ Secret scan passed${RESET}"
exit 0
