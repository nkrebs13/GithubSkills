name: Validate Skills

on:
  pull_request:
    branches:
      - main
    paths:
      - 'skills/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Skill Structure
        run: |
          echo "Validating skill structure..."
          errors=0

          for skill_dir in skills/*/; do
            skill_name=$(basename "$skill_dir")
            echo "Checking: $skill_name"

            # Check SKILL.md exists
            if [ ! -f "$skill_dir/SKILL.md" ]; then
              echo "::error file=$skill_dir::Missing SKILL.md"
              errors=$((errors + 1))
              continue
            fi

            # Check frontmatter exists
            if ! head -1 "$skill_dir/SKILL.md" | grep -q "^---"; then
              echo "::error file=$skill_dir/SKILL.md::Missing frontmatter"
              errors=$((errors + 1))
            fi

            # Check name field
            if ! grep -q "^name:" "$skill_dir/SKILL.md"; then
              echo "::error file=$skill_dir/SKILL.md::Missing 'name' in frontmatter"
              errors=$((errors + 1))
            fi

            # Check description field
            if ! grep -q "^description:" "$skill_dir/SKILL.md"; then
              echo "::error file=$skill_dir/SKILL.md::Missing 'description' in frontmatter"
              errors=$((errors + 1))
            fi

            echo "  âœ“ $skill_name passed"
          done

          if [ $errors -gt 0 ]; then
            echo "::error::Validation failed with $errors error(s)"
            exit 1
          fi

          echo "All skills validated successfully!"

      - name: Security Scan
        run: |
          echo "Running security scan..."
          python3 scripts/scan_secrets.py --directory skills/

      - name: Check Naming Conventions
        run: |
          echo "Checking naming conventions..."
          errors=0

          for skill_dir in skills/*/; do
            skill_name=$(basename "$skill_dir")

            # Check lowercase
            if [ "$skill_name" != "$(echo "$skill_name" | tr '[:upper:]' '[:lower:]')" ]; then
              echo "::error::Skill name '$skill_name' must be lowercase"
              errors=$((errors + 1))
            fi

            # Check no underscores
            if echo "$skill_name" | grep -q "_"; then
              echo "::error::Skill name '$skill_name' should use hyphens, not underscores"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            exit 1
          fi

          echo "Naming conventions OK!"
